##
# Proxy Caching
##
proxy_cache_path /var/cache/nginx keys_zone=one:10m;

server {
  listen 80;
  server_name xplatform.org www.xplatform.org *.xplatform.org;
 
  location /ext/soundcloud/tracks.json {
      gzip off;
      resolver 8.8.8.8;
      proxy_cache one;
      proxy_ignore_headers "Cache-Control";
      proxy_pass http://api.soundcloud.com/tracks.json?client_id=288c3b51bc9cfb269d1a89d92e4196a3&$args; # TODO [ToDr] This is Wkwiatek's client_id
      proxy_set_header X-Real-IP $remote_addr;
      proxy_cache_valid 200 60m;
      add_header X-Cache-Status $upstream_cache_status;
  } 

  location / {
    rewrite ^ https://$server_name$request_uri? permanent;
  }
}

server {
  server_name test.xplatform.org;
  return 301 https://xplatform.org/?anon=true#/space/53dfb356870cd20000458e35/player/0/54350e9d7311332b5378a9ad;
}

server {
	listen  443; ## listen for ipv4; this line is default and implied
	server_name xplatform.org *.xplatform.org;

	client_header_buffer_size 64k;
	large_client_header_buffers 8 128k;

  ssl on;
  ssl_certificate /etc/nginx/keys/ssl-unified.crt;
  ssl_certificate_key /etc/nginx/keys/ssl.key;

	location /static/ {
		rewrite ^/static/(.*)$ /public/$1;
	}

	location /public {
		root /home/xplatform/Projects/devmeetings-slidesapp/x-platform/;
		gzip on;
		gzip_types text/plain application/x-javascript application/javascript text/css application/octet-stream;
		
		expires 3d;
	}

  location /convert {
    proxy_cache one;
    proxy_ignore_headers "Cache-Control";
    proxy_pass http://rate-exchange.appspot.com/currency;
    proxy_set_header Host rate-exchange.appspot.com;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_cache_valid 200 60m;
    add_header X-Cache-Status $upstream_cache_status;
  }

  location /ext/github/ {
     proxy_cache one;
     proxy_ignore_headers "Cache-Control";
     proxy_pass https://api.github.com/;
     proxy_set_header X-Real-IP $remote_addr;
     proxy_cache_valid 200 60m; 
     add_header X-Cache-Status $upstream_cache_status;
     add_header User-Agent xplatform;
  }

  location /ext/soundcloud/tracks.json {
     proxy_cache one;
     resolver 8.8.8.8;
     proxy_ignore_headers "Cache-Control";
     proxy_pass http://api.soundcloud.com/tracks.json?client_id=288c3b51bc9cfb269d1a89d92e4196a3&$args; # TODO [ToDr] This is Wkwiatek's client_id
     proxy_set_header X-Real-IP $remote_addr;
     proxy_cache_valid 200 60m;
     add_header X-Cache-Status $upstream_cache_status;
  }

	location /ext/lorempixel/ {
    proxy_cache one;
		proxy_pass http://lorempixel.com/;
		proxy_set_header REFERER "http://xplatform.org";
    proxy_cache_valid 200 60m;
    add_header X-Cache-Status $upstream_cache_status;
	}

  location /ext/testReporter/ {
    proxy_pass  http://localhost:3002/;
    proxy_set_header Host      $host;
    proxy_set_header X-Real-IP $remote_addr;
  }

  location /ext/requestbin {
    proxy_pass http://requestb.in/;
    proxy_set_header Host      $host;
    proxy_set_header X-Real-IP $remote_addr;
  }

 	location / {
	    proxy_pass  http://localhost:4000;
	    proxy_set_header Host      $host;
	    proxy_set_header X-Real-IP $remote_addr;

	    proxy_http_version 1.1;
	    proxy_set_header Upgrade $http_upgrade;
	    proxy_set_header Connection "upgrade";
	    proxy_read_timeout 86400;
	}

  location /live {
      proxy_pass http://localhost:4001;
      proxy_set_header Host      $host;
	    proxy_set_header X-Real-IP $remote_addr;

	    proxy_http_version 1.1;
	    proxy_set_header Upgrade $http_upgrade;
	    proxy_set_header Connection "upgrade";
	    proxy_read_timeout 86400;
  }

	error_page 502 /offline.html;

	location = /offline.html {
	    root /home/xplatform/Projects/devmeetings-slidesapp;
	}

	location /nginx_status {
    # copied from http://blog.kovyrin.net/2006/04/29/monitoring-nginx-with-rrdtool/
    stub_status on;
    access_log   off;
  }
}

